## TESSNG分布式

### Bug

#### 在ds_test.tess路网下，运行2个worker。在最后一个worker离开（job id为1），移除该worker时，发现assignedJobId为-1

- 原因：worker的任务尚未分配，job id为-1，访问job时，没有判断job id是否存在
- 解决：添加保护即可

#### 恢复过程中，启动速度过快，worker还未连接时，会导致发送失败，后面运行不下去

#### 创建快照时，创建车辆的，车辆属性里的roadId不一致

![Tess_git (正在调试) - Microsoft Visual Studio 2023_9_20 11_11_02](./assets/Tess_git (正在调试) - Microsoft Visual Studio 2023_9_20 11_11_02.png)

#### 三个worker测试中，启动了三个，有一个在第一批次时卡在syncing，但是另两个能继续仿真

- 解决：node id和graph node id用混导致的

#### Worker重启后分配的问题

|                    |       worker       |       worker       |       worker       |
| :----------------: | :----------------: | :----------------: | :----------------: |
|      ip:port       | 192.168.1.101:1001 | 192.168.1.102:1002 | 192.168.1.103:1003 |
|      node id       |         1          |         2          |         3          |
|       job id       |         1          |         2          |         3          |
|     **发生：**     |                    |     **Failed**     |     **Failed**     |
|   **重启顺序：**   |                    |     **后启动**     |     **先启动**     |
| **Master重分配：** |                    |                    |                    |
|      ip:port       | 192.168.1.101:1001 | 192.168.1.102:1003 | 192.168.1.103:1002 |
|      node id       |         1          |         3          |         2          |
|       job id       |         1          |         3          |         2          |

- 问题描述

  master保存了failed掉前worker node id和job id的对应关系，当有worker重连时，会**绑定分配**。当2和3的重启顺序调换时，会导致原先的2分配了3（node id和job id），原先的3分配了2。

  - **若端口号和node id相关，ip地址互不同**，那么worker1重连192.168.1.102:1002  192.168.1.103:1003，连不上，新的分配下，端口号已更改。
  - **或者ip地址不同，端口号和node id无关（比如固定）**，会连错worker。
    假设worker的端口号都是1000，worker1~worker3的ip:port分别为：192.168.1.101:1000  192.168.1.102:1000，192.168.1.103:1000，当重分配后，worker的node id顺序反了，导致worker1尝试连原来的执行job2的worker2，结果连上了执行job3的worker3

- 目前情况：

  每个worker都会坚持连对应的

### 容灾测试

#### 3 x Worker测试

|          | VS Worker | Worker | Worker |              问题              |
| :------: | :-------: | :----: | :----: | :----------------------------: |
| 启动顺序 |     1     |   2    |   3    | 1. 在5w多批次时，写入redis报错 |
| 关闭顺序 |     1     |        |        |                                |
| 恢复顺序 |     1     |        |        |                                |
|          |           |        |        |                                |
| 启动顺序 |     1     |   2    |   3    |                                |
| 关闭顺序 |     1     |   2    |        |                                |
| 恢复顺序 |     1     |   2    |        |                                |
|          |           |        |        |                                |
| 启动顺序 |     1     |   2    |   3    |                                |
| 关闭顺序 |     1     |   2    |        |                                |
| 恢复顺序 |     2     |   1    |        |                                |
|          |           |        |        |                                |
| 启动顺序 |     1     |   2    |   3    |                                |
| 关闭顺序 |     1     |   2    |   3    |                                |
| 恢复顺序 |     1     |   2    |   3    |                                |
|          |           |        |        |                                |
| 启动顺序 |     1     |   2    |   3    |                                |
| 关闭顺序 |     1     |   2    |   3    |                                |
| 恢复顺序 |     2     |   1    |   3    |                                |
|          |           |        |        |                                |
| 启动顺序 |     1     |   2    |   3    |                                |
| 关闭顺序 |     1     |   2    |   3    |                                |
| 恢复顺序 |     3     |   1    |   2    |                                |

##### 条件

- 海信深圳路网

- 随机挑批次关闭，测到几w批次

## TESSNG

### Online

#### 流程

1. socketHelper：onRecvMessage接收数据
2. sharedMemoryTools：insert接收到的参数
3. paramReader：定时从sharedMemoryTools取各种参数，并保存到自己的列表容器中
